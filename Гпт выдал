"""
–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å ‚Äî –†–æ–ª—å 4 (–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è + –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è)
- –°–∏–º—É–ª—è—Ç–æ—Ä —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏–π
- –°–∏—Å—Ç–µ–º–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ü–µ–ª–µ–π
- –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –±—é–¥–∂–µ—Ç–∞ (50/30/20 —Å —É—á–µ—Ç–æ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤)
- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏: –ø—Ä–æ–≥—Ä–µ—Å—Å —Ü–µ–ª–µ–π, —ç—Ñ—Ñ–µ–∫—Ç —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, –±–∞–∑–æ–≤—ã–µ –¥–∏–∞–≥—Ä–∞–º–º—ã —Ä–∞—Å—Ö–æ–¥–æ–≤
–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –º–Ω–æ–≥–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–¥–µ–ª–∞–Ω—ã —É–ø—Ä–æ—â—ë–Ω–Ω–æ –∏ –ª–µ–≥–∫–æ –ø–æ–¥–¥–∞—é—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–µ –ø–æ–¥ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
"""

import math
from collections import defaultdict, Counter
from statistics import mean, stdev
from datetime import datetime, timedelta
import matplotlib.pyplot as plt
import copy


# ---------------------------
# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ "—É–º–Ω—ã–µ" –ø—Ä–æ—Ü–µ—Å—Å—ã (–ø—Ä–æ—Å—Ç–µ–π—à–∏–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
# ---------------------------

def smart_description_parser(transactions: list) -> list:
    """
    –ü—Ä–æ—Å—Ç–µ–π—à–∏–π –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä –æ–ø–∏—Å–∞–Ω–∏–π: –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É,
    —É–±–∏—Ä–∞–µ—Ç –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –∑–∞–º–µ–Ω—è–µ—Ç —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è.
    """
    for t in transactions:
        desc = str(t.get("description", "")).strip().lower()
        # –ø—Ä–æ—Å—Ç—ã–µ –∑–∞–º–µ–Ω—ã (–ø—Ä–∏–º–µ—Ä)
        desc = desc.replace("–ø—è—Ç–µ—Ä–æ—á–∫–µ", "–ø—è—Ç–µ—Ä–æ—á–∫–∞").replace("—Ä–µ—Å—Ç–æ—Ä–∞–Ω —Å—É—à–∏", "—Å—É—à–∏")
        t["description_norm"] = desc
    return transactions


def detect_and_convert_currency(transactions: list, target_currency: str = "RUB") -> list:
    """
    –ó–∞–≥–ª—É—à–∫–∞: –≤ —Ä–µ–∞–ª–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–∞—Ä—Å–µ—Ä –≤–∞–ª—é—Ç –∏ –∫—É—Ä—Å—ã.
    –ó–¥–µ—Å—å –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –≤—Å–µ —Å—É–º–º—ã —É–∂–µ –≤ —Ü–µ–ª–µ–≤–æ–π –≤–∞–ª—é—Ç–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–º–µ—á–∞–µ–º.
    """
    for t in transactions:
        t.setdefault("currency", target_currency)
    return transactions


def find_duplicate_transactions(transactions: list, window_days: int = 1) -> list:
    """
    –ù–∞—Ö–æ–¥–∏—Ç –≤–æ–∑–º–æ–∂–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã: –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è —Å—É–º–º–∞ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –≤ –æ–∫–Ω–µ +/- window_days.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–∞—Ä –∏–Ω–¥–µ–∫—Å–æ–≤/–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤.
    """
    duplicates = []
    indexed = list(enumerate(transactions))
    for i, t in indexed:
        for j, s in indexed[i+1:]:
            if abs(t["amount"] - s["amount"]) < 1e-6 and t.get("description_norm") == s.get("description_norm"):
                # –ø—Ä–æ–≤–µ—Ä–∏–º –±–ª–∏–∑–æ—Å—Ç—å –ø–æ –¥–∞—Ç–µ
                try:
                    di = datetime.strptime(t["date"], "%Y-%m-%d")
                    dj = datetime.strptime(s["date"], "%Y-%m-%d")
                    if abs((di - dj).days) <= window_days:
                        duplicates.append((i, j))
                except Exception:
                    pass
    return duplicates


def add_tags_to_transactions(transactions: list, tags_map: dict = None) -> list:
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–≥–∏ –∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º.
    tags_map: { "food": ["–ø–∏—Ü—Ü–∞","—Ä–µ—Å—Ç–æ—Ä–∞–Ω"], ... }
    """
    if tags_map is None:
        tags_map = {
            "food": ["–ø—è—Ç–µ—Ä–æ—á–∫–∞", "–º–∞–≥–Ω–∏—Ç", "—Å—É—à–∏", "–∫–∞—Ñ–µ", "—Ä–µ—Å—Ç–æ—Ä–∞–Ω", "–µ–¥–∞", "–¥–æ—Å—Ç–∞–≤–∫–∞"],
            "transport": ["–º–µ—Ç—Ä–æ", "—Ç–∞–∫—Å–∏", "–∞–≤—Ç–æ–±—É—Å", "–±–µ–Ω–∑–∏–Ω"],
            "subscription": ["–ø–æ–¥–ø–∏—Å–∫–∞", "netflix", "spotify"],
            "electronics": ["–º–≤–∏–¥–µ–æ", "—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –º–∏—Ä", "dns", "—Å–∏—Ç–∏–ª–∏–Ω–∫"],
        }
    for t in transactions:
        desc = t.get("description_norm", t.get("description", "")).lower()
        tags = set()
        for tag, keywords in tags_map.items():
            for kw in keywords:
                if kw in desc:
                    tags.add(tag)
                    break
        t["tags"] = list(tags) if tags else []
    return transactions


def identify_recurring_payments(transactions: list, min_occurrences: int = 3) -> list:
    """
    –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏: –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –æ–ø–∏—Å–∞–Ω–∏—é
    –∏ —Å–º–æ—Ç—Ä–∏–º, —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –≤ —Ä–∞–∑–Ω—ã–µ –º–µ—Å—è—Ü—ã.
    –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö recurring: [{"description": ..., "avg_amount":..., "frequency":"monthly"}]
    """
    groups = defaultdict(list)
    for t in transactions:
        key = t.get("description_norm", t.get("description", "")).strip()
        groups[key].append(t)

    recurring = []
    for desc, items in groups.items():
        if len(items) < min_occurrences:
            continue
        # –ø—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Å—è—á–Ω—É—é —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –º–µ—Å—è—Ü—ã
        months = set()
        amounts = []
        for it in items:
            try:
                months.add(datetime.strptime(it["date"], "%Y-%m-%d").strftime("%Y-%m"))
            except Exception:
                pass
            amounts.append(abs(it["amount"]) if it["amount"] < 0 else 0)
        if len(months) >= min_occurrences:
            recurring.append({
                "description": desc,
                "count": len(items),
                "unique_months": len(months),
                "avg_amount": round(mean(amounts), 2),
                "frequency": "monthly"
            })
    return recurring


# ---------------------------
# –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ "–∑–¥–æ—Ä–æ–≤—å–µ"
# ---------------------------

def calculate_basic_stats(transactions: list) -> dict:
    """
    –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏: –¥–æ—Ö–æ–¥, —Ä–∞—Å—Ö–æ–¥, –±–∞–ª–∞–Ω—Å, –∫–æ–ª-–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–∞–∫–∂–µ totals_by_category (–ø–æ –∏–º–µ—é—â–∏–º—Å—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º).
    """
    total_income = 0.0
    total_expenses = 0.0
    totals_by_category = defaultdict(float)
    for t in transactions:
        amt = float(t["amount"])
        if amt >= 0:
            total_income += amt
        else:
            total_expenses += abs(amt)
            cat = t.get("category", t.get("tags", ["–¥—Ä—É–≥–æ–µ"])[0] if t.get("tags") else "–¥—Ä—É–≥–æ–µ")
            totals_by_category[cat] += abs(amt)
    stats = {
        "income": round(total_income, 2),
        "expenses": round(total_expenses, 2),
        "balance": round(total_income - total_expenses, 2),
        "transactions_count": len(transactions),
        "totals_by_category": dict(totals_by_category)
    }
    return stats


def calculate_financial_health_score(transactions: list) -> dict:
    """
    –ü—Ä–æ—Å—Ç–µ–π—à–∞—è –º–µ—Ç—Ä–∏–∫–∞ "–∑–¥–æ—Ä–æ–≤—å—è":
    - savings_rate = —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è / –¥–æ—Ö–æ–¥—ã (–µ—Å–ª–∏ –¥–æ—Ö–æ–¥—ã > 0)
    - eating_out_ratio = –¥–æ–ª—è —Ç—Ä–∞—Ç –ø–æ —Ç–µ–≥—É food / —Ä–∞—Å—Ö–æ–¥–æ–≤
    - cash_flow_per_week
    - health_score: 0..100 –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Å—Ç—ã—Ö –ø—Ä–∞–≤–∏–ª
    """
    stats = calculate_basic_stats(transactions)
    income = stats["income"]
    expenses = stats["expenses"]
    savings = max(0.0, income - expenses)
    savings_rate = (savings / income) if income > 0 else 0.0

    # eating_out_ratio: –∏—â–µ–º —Ç–µ–≥–∏ "food" –∏–ª–∏ category "–µ–¥–∞"
    food_spend = 0.0
    for t in transactions:
        desc = t.get("description_norm", "")
        if "–ø–∏—Ü—Ü–∞" in desc or "—Ä–µ—Å—Ç–æ—Ä–∞–Ω" in desc or "–∫–∞—Ñ–µ" in desc or "–¥–æ—Å—Ç–∞–≤–∫–∞" in desc or "–ø—è—Ç–µ—Ä–æ—á–∫–∞" in desc or t.get("category") == "–µ–¥–∞":
            if t["amount"] < 0:
                food_spend += abs(t["amount"])
    eating_out_ratio = (food_spend / expenses) if expenses > 0 else 0.0

    # cash flow per week (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ)
    dates = []
    for t in transactions:
        try:
            dates.append(datetime.strptime(t["date"], "%Y-%m-%d"))
        except Exception:
            pass
    if dates:
        span_days = (max(dates) - min(dates)).days or 1
        weeks = max(1, span_days / 7)
        cash_flow_week = (income - expenses) / weeks
    else:
        cash_flow_week = 0.0

    # health score: –ø—Ä–æ—Å—Ç–∞—è —à–∫–∞–ª–∞: –±–∞–∑–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞
    score = 50
    if savings_rate > 0.2:
        score += 20
    elif savings_rate > 0.1:
        score += 10
    else:
        score -= 10

    if eating_out_ratio > 0.3:
        score -= 10
    else:
        score += 5

    if cash_flow_week > 0:
        score += min(15, int(cash_flow_week / 1000))
    else:
        score -= 10

    score = max(0, min(100, score))

    return {
        "income": income,
        "expenses": expenses,
        "savings": round(savings, 2),
        "savings_rate": round(savings_rate, 3),
        "eating_out_ratio": round(eating_out_ratio, 3),
        "cash_flow_per_week": round(cash_flow_week, 2),
        "health_score": score
    }


def predict_future_spending(transactions: list, days: int = 30) -> dict:
    """
    –ü—Ä–æ–≥–Ω–æ–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ N –¥–Ω–µ–π –ø–æ –ø—Ä–æ—Å—Ç–æ–º—É —Å–∫–æ–ª—å–∑—è—â–µ–º—É —Å—Ä–µ–¥–Ω–µ–º—É.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å { "predicted_total": ..., "daily": ... }
    """
    # –±–µ—Ä—ë–º –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –¥–∞—Ç–µ
    day_totals = defaultdict(float)
    for t in transactions:
        try:
            d = datetime.strptime(t["date"], "%Y-%m-%d").date()
        except Exception:
            continue
        if t["amount"] < 0:
            day_totals[d] += abs(t["amount"])

    if not day_totals:
        return {"predicted_total": 0.0, "daily": [0.0] * days}

    # —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ –∏ –±–µ—Ä–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30/60 –¥–Ω–µ–π
    amounts = list(day_totals.values())
    avg_daily = mean(amounts)
    predicted_daily = [round(avg_daily, 2)] * days
    predicted_total = round(avg_daily * days, 2)
    return {"predicted_total": predicted_total, "daily": predicted_daily}


def detect_spending_anomalies(transactions: list) -> list:
    """
    –ù–∞—Ö–æ–¥–∏—Ç –∞–Ω–æ–º–∞–ª—å–Ω—ã–µ —Ç—Ä–∞—Ç—ã: –ª—é–±—ã–µ —Ä–∞—Å—Ö–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –±–æ–ª—å—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø–æ —Å—É–º–º–∞–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π).
    """
    amounts = [abs(t["amount"]) for t in transactions if t["amount"] < 0]
    if len(amounts) < 2:
        return []

    avg = mean(amounts)
    try:
        sd = stdev(amounts)
    except Exception:
        sd = 0.0

    threshold = avg + 3 * sd
    anomalies = []
    for t in transactions:
        if t["amount"] < 0 and abs(t["amount"]) > threshold:
            anomalies.append({
                "date": t["date"],
                "amount": abs(t["amount"]),
                "description": t.get("description", ""),
            })
    return anomalies


# ---------------------------
# –ó–∞–¥–∞—á–∞ 4.4: –°–∏–º—É–ª—è—Ç–æ—Ä —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏–π
# ---------------------------

def simulate_financial_decisions(budget: dict, scenarios: list, months: int = 12) -> dict:
    """
    –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–∏ (—Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å "impact") –∏ –º–æ–¥–µ–ª–∏—Ä—É–µ—Ç –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –Ω–∞ budget –∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è.
    –§–æ—Ä–º–∞—Ç scenario: {"action": str, "impact": {"transport": +15000, "savings": -500000, "income": +20000}}
    - positive numbers for recurring monthly increases (–Ω–∞–ø—Ä–∏–º–µ—Ä transport:+15000 –∑–Ω–∞—á–∏—Ç —Ä–∞—Å—Ö–æ–¥—ã –≤ transport —É–≤–µ–ª–∏—á–∞—Ç—Å—è –Ω–∞ 15000/–º–µ—Å)
    - special keys: "savings" / "income" can be lump-sum (negative for decrease) or positive
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è ‚Äî –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è–º/–≤—Ä–µ–º–µ–Ω–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–µ–π –∏ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–π –±—é–¥–∂–µ—Ç.
    """
    results = []
    base_budget = copy.deepcopy(budget)

    # helper to sum monthly budgeted expenses (excluding "–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è")
    def monthly_expense_from_budget(b):
        return sum(info["limit"] for k, info in b.items() if k != "–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è")

    base_monthly_exp = monthly_expense_from_budget(base_budget)
    base_savings_limit = base_budget.get("–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è", {}).get("limit", 0)

    for scen in scenarios:
        s = copy.deepcopy(scen)
        action = s.get("action", "action")
        impact = s.get("impact", {})
        b_new = copy.deepcopy(base_budget)

        # Apply monthly impacts to categories
        for k, v in impact.items():
            if k == "income":
                # increase monthly income ‚Äî reflect by increasing "–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è" capacity proportionally
                # Here we treat income impact as monthly recurring
                b_new.setdefault("–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è", {"limit": base_savings_limit})
                b_new["–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è"]["limit"] = round(b_new["–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è"]["limit"] + v * 0.5, 2)
            elif k == "savings":
                # lump-sum decrease/increase in savings -> reduce/add recommended savings (one-time)
                b_new.setdefault("–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è", {"limit": base_savings_limit, "recommended": base_savings_limit})
                b_new["–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è"]["limit"] = round(max(0, b_new["–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è"]["limit"] + v), 2)
            else:
                # category impact: treat as monthly change in expenses (positive means more expense)
                if k in b_new:
                    b_new[k]["limit"] = round(max(0, b_new[k]["limit"] + v), 2)
                else:
                    # if category absent ‚Äî create it
                    b_new[k] = {"limit": round(max(0, v), 2), "recommended": round(max(0, v), 2)}

        # Simulate months: compute cumulative savings if user follows new budget limits
        monthly_income = s.get("monthly_income_override")  # optional override
        # approximate income from budget: income = expenses + savings_target + cashflow? We cannot derive income reliably.
        # For simulation we compute delta between base monthly expense and new one and see effect on savings limit.
        new_monthly_exp = monthly_expense_from_budget(b_new)
        monthly_savings_target = b_new.get("–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è", {}).get("limit", base_savings_limit)
        # naive projection: monthly_free = (previously saved) + (old_exp - new_exp)
        # assume user maintains same income; savings change = old_monthly_exp - new_monthly_exp (if new_exp less)
        delta_monthly = round(base_monthly_exp - new_monthly_exp, 2)
        # cumulative savings over months
        cumulative_savings = []
        curr = b_new.get("–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è", {}).get("recommended", monthly_savings_target)
        # start from 0 extra
        extra = 0.0
        for m in range(months):
            extra += delta_monthly
            cumulative_savings.append(round(extra, 2))

        results.append({
            "action": action,
            "modified_budget": b_new,
            "delta_monthly": delta_monthly,
            "cumulative_savings_12m": cumulative_savings,
        })

    return {"base_budget": base_budget, "scenarios": results}


# ---------------------------
# –ó–∞–¥–∞—á–∞ 4.5: –°–∏—Å—Ç–µ–º–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ü–µ–ª–µ–π
# ---------------------------

def track_financial_goals(budget: dict, goals: list) -> dict:
    """
    goals: —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π: {"name":..., "target":int, "current":int, "deadline":"YYYY-MM-DD", "priority":1}
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å, % –∏ —Å—Ç–∞—Ç—É—Å (on track / behind).
    –î–ª—è –æ—Ü–µ–Ω–∫–∏ "on track" –º—ã —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ç—Ä–µ–±—É–µ–º—É—é –µ–∂–µ–º–µ—Å—è—á–Ω—É—é —Å—É–º–º—É —Å —Ç–µ–∫—É—â–∏–º–∏ –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è–º–∏ (budget["–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è"]["limit"])
    """
    results = []
    savings_monthly_capacity = budget.get("–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è", {}).get("limit", 0.0)
    today = datetime.today().date()
    for g in goals:
        name = g["name"]
        target = float(g["target"])
        current = float(g.get("current", 0.0))
        deadline_str = g.get("deadline")
        try:
            deadline = datetime.strptime(deadline_str, "%Y-%m-%d").date()
            months_left = max(0.0, (deadline - today).days / 30.0)
        except Exception:
            months_left = None

        remaining = max(0.0, target - current)
        percent = round((current / target) * 100, 1) if target > 0 else 0.0

        if months_left and months_left > 0:
            required_per_month = round(remaining / months_left, 2)
            if savings_monthly_capacity >= required_per_month:
                status = "–ø–æ –ø–ª–∞–Ω—É"
            else:
                # estimate delay in months if only using savings_monthly_capacity
                if savings_monthly_capacity > 0:
                    months_needed = math.ceil(remaining / savings_monthly_capacity)
                    status = f"–æ—Ç—Å—Ç–∞–µ—Ç–µ, –Ω—É–∂–Ω–æ ~{months_needed} –º–µ—Å."
                else:
                    status = "–æ—Ç—Å—Ç–∞–µ—Ç–µ (–Ω–µ—Ç –º–µ—Å—è—á–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤)"
        else:
            required_per_month = None
            status = "—Å—Ä–æ–∫ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω"

        results.append({
            "name": name,
            "target": target,
            "current": current,
            "percent": percent,
            "deadline": deadline_str,
            "required_per_month": required_per_month,
            "status": status
        })

    return {"monthly_capacity": savings_monthly_capacity, "goals": results}


# ---------------------------
# –ó–∞–¥–∞—á–∞ 4.6: –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
# ---------------------------

def generate_personalized_advice(analysis: dict, user_profile: dict = None) -> list:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ (analysis ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç calculate_financial_health_score).
    user_profile: –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã, –≤–æ–∑—Ä–∞—Å—Ç/—Å–µ–º—å—é –∏ —Ç.–ø. (—É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —É–ø—Ä–æ—â–µ–Ω–Ω–æ)
    """
    advice = []
    if not analysis:
        return advice

    if analysis.get("eating_out_ratio", 0) > 0.3:
        advice.append("–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Ç—Ä–∞—Ç–∏—Ç–µ –Ω–∞ –µ–¥—É –≤–Ω–µ –¥–æ–º–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≥–æ—Ç–æ–≤–∏—Ç—å –¥–æ–º–∞ 3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é.")
    if analysis.get("savings_rate", 0) < 0.1:
        advice.append("–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å –º–∏–Ω–∏–º—É–º 10% –æ—Ç –¥–æ—Ö–æ–¥–∞ ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–π—Ç–µ –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Å–±–µ—Ä—Å—á—ë—Ç.")
    if analysis.get("cash_flow_per_week", 0) < 0:
        advice.append("–ü–æ–ª–æ–∂–∏—Ç–µ —á–∞—Å—Ç—å –∑–∞—Ä–ø–ª–∞—Ç—ã –Ω–∞ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π —Ä–µ–∑–µ—Ä–≤ ‚Äî 1-2% –¥–æ—Ö–æ–¥–∞.")
    # –ø—Ä–æ—Ñ–∏–ª—å–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
    if user_profile:
        if user_profile.get("has_children"):
            advice.append("–£–≤–µ–ª–∏—á—å—Ç–µ —Ä–µ–∑–µ—Ä–≤ –Ω–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã (3-6 –º–µ—Å—è—Ü–µ–≤).")
        if user_profile.get("age") and user_profile["age"] > 50:
            advice.append("–ü–æ–¥—É–º–∞–π—Ç–µ –æ–± —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã—Ö –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π –∏ —Å–Ω–∏–∂–µ–Ω–∏–∏ —Ä–∏—Å–∫–æ–≤.")
    # –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–µ —Å–æ–≤–µ—Ç—ã
    advice.append("–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –∫—ç—à–±–µ–∫-–∫–∞—Ä—Ç—É –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫ (—Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç—ã, –∑–∞–ø—Ä–∞–≤–∫–∏).")
    return advice


# ---------------------------
# –ó–∞–¥–∞—á–∞ 4.7: –û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä –±—é–¥–∂–µ—Ç–∞
# ---------------------------

def optimize_budget_allocation(current_budget: dict, goals: list, user_priorities: dict = None) -> dict:
    """
    –ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç–æ–¥–∞ 50/30/20 –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–Ω–æ–π —Ç–æ—á–∫–∏,
    –Ω–æ —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Ü–µ–ª–µ–π (priority: 1..N, 1 ‚Äî highest).
    current_budget: —Å–ª–æ–≤–∞—Ä—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -> {"limit":.., "recommended":..}
    goals: —Å–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–π, –∫–∞–∂–¥–∞—è –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –ø–æ–ª–µ priority (—á–µ–º –º–µ–Ω—å—à–µ ‚Äî –≤—ã—à–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
    user_priorities: –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–µ—Å–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—ã–π —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –±—é–¥–∂–µ—Ç (–≤–∫–ª—é—á–∞—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è).
    """
    # –°—á–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Å—É–º–º—ã
    total_expenses = sum(info["limit"] for k, info in current_budget.items() if k != "–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è")
    current_savings = current_budget.get("–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è", {}).get("limit", 0.0)
    total_income_est = total_expenses + current_savings  # –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –¥–æ—Ö–æ–¥–∞

    # —Ü–µ–ª–µ–≤—ã–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
    need_share = 0.5
    want_share = 0.3
    save_share = 0.2

    # –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã ‚Äî –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º —á–∞—Å—Ç—å "want" –≤ "save" –∏–ª–∏ –≤ –Ω—É–∂–¥—ã
    goal_priority_weight = 0.0
    for g in goals:
        if g.get("priority") and g["priority"] <= 2:
            goal_priority_weight += 0.05  # –Ω–µ–±–æ–ª—å—à–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –Ω–∞ –∫–∞–∂–¥—É—é –≤–∞–∂–Ω—É—é —Ü–µ–ª—å

    # –∏—Ç–æ–≥–æ–≤—ã–µ –¥–æ–ª–∏ —Å —É—á—ë—Ç–æ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ (–Ω–æ—Ä–º–∏—Ä—É–µ–º)
    save_share = min(0.6, save_share + goal_priority_weight)
    want_share = max(0.05, 1.0 - (need_share + save_share))
    # –±—é–¥–∂–µ—Ç–∏—Ä—É–µ–º –ø–æ —Å—É–º–º–µ –¥–æ—Ö–æ–¥–∞ (–æ—Ü–µ–Ω–æ—á–Ω–æ–π)
    new_savings_target = round(total_income_est * save_share, 2)
    need_budget = round(total_income_est * need_share, 2)
    want_budget = round(total_income_est * want_share, 2)

    # –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º need_budget —Å–Ω–∞—á–∞–ª–∞ –ø–æ —Ç–µ–∫—É—â–∏–º 'essential' –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (–Ω–∞–ø—Ä–∏–º–µ—Ä housing, food, transport, utilities)
    essentials = ["housing", "–µ–¥–∞", "transport", "utilities", "health"]
    new_budget = {}
    # extract current category shares
    current_categories = {k: v["limit"] for k, v in current_budget.items() if k != "–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è"}
    total_current = sum(current_categories.values()) or 1.0
    # Pro-rate the need_budget according to current shares but prioritize essentials
    essentials_sum = sum(current_categories.get(k, 0.0) for k in essentials)
    if essentials_sum == 0:
        essentials_sum = total_current  # fallback

    for cat, cur_val in current_categories.items():
        weight = cur_val / total_current
        # if cat in essentials -> extra weight
        if cat in essentials:
            weight *= 1.2
        # assign from need+want proportionally
        new_val = round((need_budget + want_budget) * weight, 2)
        new_budget[cat] = {"limit": new_val, "recommended": round(cur_val, 2)}

    # set savings
    new_budget["–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è"] = {"limit": new_savings_target, "recommended": new_savings_target}
    return {"estimated_income": round(total_income_est, 2), "new_budget": new_budget}


# ---------------------------
# –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ (matplotlib)
# ---------------------------

def visualize_goals_progress(goals_report: dict, save_path: str = None):
    """
    –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å —Ü–µ–ª–µ–π (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –±–∞—Ä—ã) –∏ –ø–æ–º–µ—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å.
    """
    goals = goals_report["goals"]
    names = [g["name"] for g in goals]
    percents = [g["percent"] for g in goals]
    statuses = [g["status"] for g in goals]

    fig, ax = plt.subplots(figsize=(8, max(3, len(goals)*0.6)))
    bars = ax.barh(names, percents)
    ax.set_xlim(0, 100)
    ax.set_xlabel("–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (%)")
    ax.set_title("–ü—Ä–æ–≥—Ä–µ—Å—Å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ü–µ–ª–µ–π")

    for i, (bar, st) in enumerate(zip(bars, statuses)):
        w = bar.get_width()
        ax.text(w + 1, bar.get_y() + bar.get_height()/2, st, va='center', fontsize=9)

    plt.tight_layout()
    if save_path:
        plt.savefig(save_path)
    plt.show()


def visualize_simulation_results(simulation: dict, months: int = 12, save_path: str = None):
    """
    –ü–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º simulate_financial_decisions —Å—Ç—Ä–æ–∏—Ç –≥—Ä–∞—Ñ–∏–∫ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é.
    """
    scenarios = simulation["scenarios"]
    fig, ax = plt.subplots(figsize=(9, 5))
    x = list(range(1, months+1))
    for s in scenarios:
        ax.plot(x, s["cumulative_savings_12m"], label=s["action"], marker='o')
    ax.set_xlabel("–ú–µ—Å—è—Ü—ã")
    ax.set_ylabel("–ö—É–º—É–ª—è—Ç–∏–≤–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è (—É—Å–ª–æ–≤–Ω–∞—è, —Ä—É–±.)")
    ax.set_title("–≠—Ñ—Ñ–µ–∫—Ç —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –Ω–∞ –∫—É–º—É–ª—è—Ç–∏–≤–Ω—É—é —ç–∫–æ–Ω–æ–º–∏—é")
    ax.legend()
    ax.grid(axis="y", linestyle="--", alpha=0.6)
    plt.tight_layout()
    if save_path:
        plt.savefig(save_path)
    plt.show()


def visualize_budget_report(budget_report: dict):
    """
    –†–∏—Å—É–µ—Ç –±—é–¥–∂–µ—Ç vs —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—Ö–æ–¥—ã (–∫–∞–∫ —Ä–∞–Ω–µ–µ).
    –û–∂–∏–¥–∞–µ—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç budget_report: {category: {"limit":.., "actual":.., ...}}
    """
    categories = [c for c in budget_report.keys() if c != "–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è"]
    actuals = [budget_report[c]["actual"] for c in categories]
    limits = [budget_report[c]["limit"] for c in categories]

    # bar actuals
    plt.figure(figsize=(8, 5))
    plt.bar(categories, actuals)
    plt.title("–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º")
    plt.xticks(rotation=30)
    plt.tight_layout()
    plt.show()

    # budget vs actual
    plt.figure(figsize=(8, 5))
    x = range(len(categories))
    plt.bar([i - 0.2 for i in x], limits, width=0.4, label="–õ–∏–º–∏—Ç")
    plt.bar([i + 0.2 for i in x], actuals, width=0.4, label="–§–∞–∫—Ç")
    plt.xticks(x, categories, rotation=30)
    plt.legend()
    plt.title("–ë—é–¥–∂–µ—Ç vs –§–∞–∫—Ç")
    plt.tight_layout()
    plt.show()


# ---------------------------
# –ü–µ—á–∞—Ç—å –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞
# ---------------------------

def print_comprehensive_report(stats, health_score, predictions, anomalies, goals_report, advice, optimized):
    print("\n=== –°–£–ü–ï–†-–û–¢–ß–Å–¢ ===\n")
    print("–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:")
    print(f"‚Ä¢ –î–æ—Ö–æ–¥—ã: {stats['income']} —Ä—É–±.")
    print(f"‚Ä¢ –†–∞—Å—Ö–æ–¥—ã: {stats['expenses']} —Ä—É–±.")
    print(f"‚Ä¢ –ë–∞–ª–∞–Ω—Å: {stats['balance']} —Ä—É–±.")
    print(f"‚Ä¢ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: {stats['transactions_count']}")

    print("\n–§–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ:")
    print(f"‚Ä¢ Health score: {health_score['health_score']} / 100")
    print(f"‚Ä¢ Savings rate: {health_score['savings_rate']*100:.1f}%")
    print(f"‚Ä¢ Eating out ratio: {health_score['eating_out_ratio']*100:.1f}%")
    print(f"‚Ä¢ Cash flow per week: {health_score['cash_flow_per_week']} —Ä—É–±./–Ω–µ–¥")

    print("\n–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ –¥–Ω–∏:")
    print(f"‚Ä¢ –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –∑–∞ {len(predictions['daily'])} –¥–Ω–µ–π: {predictions['predicted_total']} —Ä—É–±.")

    print("\n–ê–Ω–æ–º–∞–ª–∏–∏:")
    if anomalies:
        for a in anomalies:
            print(f"‚Ä¢ {a['date']}: {a['amount']} —Ä—É–±. ‚Äî {a['description']}")
    else:
        print("‚Ä¢ –ù–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ")

    print("\n–¶–µ–ª–∏:")
    for g in goals_report["goals"]:
        print(f"‚Ä¢ {g['name']}: {g['current']}/{g['target']} ({g['percent']}%) ‚Äî {g['status']} (deadline: {g['deadline']})")

    print("\n–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Å–æ–≤–µ—Ç—ã:")
    for i, s in enumerate(advice, 1):
        print(f"{i}. {s}")

    print("\n–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±—é–¥–∂–µ—Ç (–∫—Ä–∞—Ç–∫–æ):")
    print(f"–û—Ü–µ–Ω–æ—á–Ω—ã–π –¥–æ—Ö–æ–¥: {optimized['estimated_income']}")
    for cat, info in optimized["new_budget"].items():
        print(f"‚Ä¢ {cat}: –ª–∏–º–∏—Ç {info['limit']} (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ {info['recommended']})")
    print("\n--- –ö–û–ù–ï–¶ –û–¢–ß–Å–¢–ê ---\n")


# ---------------------------
# main_enhanced ‚Äî orchestration
# ---------------------------

def main_enhanced():
    # 1. –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∏–º–ø–æ—Ä—Ç (–≤ —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ import_financial_data)
    transactions = [
        {"date": "2024-01-15", "amount": -1500.50, "description": "–ü—Ä–æ–¥—É–∫—Ç—ã –≤ –ü—è—Ç–µ—Ä–æ—á–∫–µ", "type": "—Ä–∞—Å—Ö–æ–¥", "category": "–µ–¥–∞"},
        {"date": "2024-01-10", "amount": 50000.00, "description": "–ó–∞—Ä–ø–ª–∞—Ç–∞", "type": "–¥–æ—Ö–æ–¥", "category": "–¥–æ—Ö–æ–¥"},
        {"date": "2024-01-08", "amount": -350, "description": "–ú–µ—Ç—Ä–æ", "type": "—Ä–∞—Å—Ö–æ–¥", "category": "transport"},
        {"date": "2024-01-05", "amount": -1200, "description": "–†–µ—Å—Ç–æ—Ä–∞–Ω –°—É—à–∏", "type": "—Ä–∞—Å—Ö–æ–¥", "category": "–µ–¥–∞"},
        {"date": "2024-01-03", "amount": -450, "description": "–ê–ø—Ç–µ–∫–∞", "type": "—Ä–∞—Å—Ö–æ–¥", "category": "health"},
        {"date": "2024-02-10", "amount": -15000, "description": "–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –º–∏—Ä ‚Äî —Ç–µ–ª–µ–≤–∏–∑–æ—Ä", "type": "—Ä–∞—Å—Ö–æ–¥", "category": "electronics"},
        {"date": "2024-02-01", "amount": -600, "description": "Netflix –ø–æ–¥–ø–∏—Å–∫–∞", "type": "—Ä–∞—Å—Ö–æ–¥", "category": "subscription"},
        {"date": "2024-03-01", "amount": -600, "description": "Netflix –ø–æ–¥–ø–∏—Å–∫–∞", "type": "—Ä–∞—Å—Ö–æ–¥", "category": "subscription"},
        {"date": "2024-04-01", "amount": -600, "description": "Netflix –ø–æ–¥–ø–∏—Å–∫–∞", "type": "—Ä–∞—Å—Ö–æ–¥", "category": "subscription"},
    ]

    transactions = smart_description_parser(transactions)
    transactions = detect_and_convert_currency(transactions)
    duplicates = find_duplicate_transactions(transactions)
    transactions = add_tags_to_transactions(transactions)
    recurring = identify_recurring_payments(transactions)

    # 2. –£–º–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è ‚Äî –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —Ä–æ–ª—å 2 —É–∂–µ –¥–æ–±–∞–≤–∏–ª–∞ 'category'; –µ—Å–ª–∏ –Ω–µ—Ç, –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å categorize_all_transactions
    # (–∑–¥–µ—Å—å –ø—Ä–æ–ø—É—Å–∫–∞–µ–º, –ø–æ—Å–∫–æ–ª—å–∫—É –≤ –ø—Ä–∏–º–µ—Ä–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –µ—Å—Ç—å)

    # 3. –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑
    stats = calculate_basic_stats(transactions)
    health_score = calculate_financial_health_score(transactions)
    predictions = predict_future_spending(transactions, 30)
    anomalies = detect_spending_anomalies(transactions)

    # 4. –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
    # –°–æ–∑–¥–∞–¥–∏–º —à–∞–±–ª–æ–Ω –±—é–¥–∂–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ avg (—É–ø—Ä–æ—â—ë–Ω–Ω–æ –≤–æ–∑—å–º–µ–º —Å—Ä–µ–¥–Ω–∏–µ)
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é create_budget_template, –Ω–æ –æ–Ω–∞ –æ–∂–∏–¥–∞–µ—Ç "analysis" ‚Äî —Å–æ–∑–¥–∞–¥–∏–º –ø—Ä–æ—Å—Ç—É—é —Ñ–æ—Ä–º—É
    avg_spending = {}
    # –≤–æ–∑—å–º—ë–º —Å—É–º–º–∞—Ä–Ω—ã–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —É—Å—Ä–µ–¥–Ω–∏–º –Ω–∞ 1 –º–µ—Å—è—Ü (—É–ø—Ä–æ—â–µ–Ω–∏–µ)
    for cat, total in stats["totals_by_category"].items():
        avg_spending[cat] = total  # —Å—á–∏—Ç–∞—Ç—å –∫–∞–∫ –º–µ—Å—è—á–Ω—ã–π
    analysis_like = {"average_spending": avg_spending, "top_categories": sorted(avg_spending, key=avg_spending.get, reverse=True)}
    budget = create_budget_template(analysis_like, total_income=stats["income"])

    # –ü—Ä–∏–º–µ—Ä —Ü–µ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_goals = [
        {"name": "–æ—Ç–ø—É—Å–∫", "target": 100000, "current": 45000, "deadline": "2024-07-01", "priority": 1},
        {"name": "–Ω–æ–≤—ã–π –Ω–æ—É—Ç–±—É–∫", "target": 80000, "current": 15000, "deadline": "2024-03-01", "priority": 2}
    ]
    goals_report = track_financial_goals(budget, user_goals)
    user_profile = {"age": 30, "has_children": False}
    advice = generate_personalized_advice(health_score, user_profile)
    optimized = optimize_budget_allocation(budget, user_goals)

    # –°–∏–º—É–ª—è—Ü–∏—è —Ä–µ—à–µ–Ω–∏–π
    scenarios = [
        {"action": "–∫—É–ø–∏—Ç—å –º–∞—à–∏–Ω—É", "impact": {"transport": 15000, "savings": -500000}},
        {"action": "—Å–º–µ–Ω–∏—Ç—å —Ä–∞–±–æ—Ç—É ( +20k )", "impact": {"income": 20000}},
        {"action": "–≤–∑—è—Ç—å –∏–ø–æ—Ç–µ–∫—É", "impact": {"housing": 25000, "savings": -2000000}}
    ]
    simulation = simulate_financial_decisions(budget, scenarios, months=12)

    # –í—ã–≤–æ–¥–∏–º –æ—Ç—á—ë—Ç
    print_comprehensive_report(stats, health_score, predictions, anomalies, goals_report, advice, optimized)

    # –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
    visualize_goals_progress(goals_report)
    visualize_simulation_results(simulation, months=12)
    # –î–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –±—é–¥–∂–µ—Ç–∞ –Ω–∞–º –Ω—É–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ —Å—Ä–∞–≤–Ω–∏—Ç—å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ –±—é–¥–∂–µ—Ç
    comparison = compare_budget_vs_actual(budget, transactions)
    visualize_budget_report(comparison["budget_report"])


# ---------------------------
# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–Ω–µ–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ create_budget_template –∏ compare_budget_vs_actual
# (–∏–∑ —Ç–≤–æ–µ–≥–æ –±–∞–∑–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è ‚Äî –µ—Å–ª–∏ –æ–Ω —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω, —Ç–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—â–∏–π –∫–æ–¥)
# ---------------------------

def create_budget_template(analysis: dict, total_income: float = None) -> dict:
    """
    –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ –±–∞–∑–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Å—é–¥–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ –¥–ª—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –º–æ–¥—É–ª—è.
    """
    avg_spending = analysis.get("average_spending", {})
    if not avg_spending:
        return {}

    total_expenses = sum(avg_spending.values())
    if total_income and total_income > total_expenses:
        savings_target = round((total_income - total_expenses) * 0.5, 2)
    else:
        savings_target = round(total_expenses * 0.1, 2)

    budget = {}
    for category, avg_amount in avg_spending.items():
        limit = round(avg_amount * 1.1, 2)
        budget[category] = {"limit": limit, "recommended": avg_amount}

    budget["–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è"] = {"limit": savings_target, "recommended": savings_target}
    return budget


def compare_budget_vs_actual(budget: dict, actual_transactions: list) -> dict:
    """
    –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –±—é–¥–∂–µ—Ç–∞ –∏ —Ñ–∞–∫—Ç–∞ (–∫–æ–ø–∏—è –∏–∑ –±–∞–∑–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏).
    """
    actual_spending = defaultdict(float)
    for t in actual_transactions:
        if t["amount"] < 0:
            cat = t.get("category", t.get("tags", ["–¥—Ä—É–≥–æ–µ"])[0] if t.get("tags") else "–¥—Ä—É–≥–æ–µ")
            actual_spending[cat] += abs(t["amount"])

    report = {}
    total_overspent = 0.0

    for category, info in budget.items():
        limit = info["limit"]
        actual = actual_spending.get(category, 0.0)
        diff = round(limit - actual, 2)
        status = "‚úÖ –í –ø—Ä–µ–¥–µ–ª–∞—Ö –±—é–¥–∂–µ—Ç–∞" if diff >= 0 else "‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞"
        if diff < 0:
            total_overspent += abs(diff)
        report[category] = {
            "limit": limit,
            "actual": round(actual, 2),
            "difference": diff,
            "status": status
        }

    recommendations = []
    if total_overspent > 0:
        recommendations.append(f"–í—ã –ø—Ä–µ–≤—ã—Å–∏–ª–∏ –±—é–¥–∂–µ—Ç –Ω–∞ {total_overspent:.2f} —Ä—É–±. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞—Ç—ã.")
    else:
        recommendations.append("–û—Ç–ª–∏—á–Ω–æ! –í—ã —É–∫–ª–∞–¥—ã–≤–∞–µ—Ç–µ—Å—å –≤ –±—é–¥–∂–µ—Ç üéâ")

    return {"budget_report": report, "recommendations": recommendations}


# ---------------------------
# –ï—Å–ª–∏ —ç—Ç–æ—Ç —Ñ–∞–π–ª –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∫ —Å–∫—Ä–∏–ø—Ç ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ–º main_enhanced()
# ---------------------------

if __name__ == "__main__":
    main_enhanced()
